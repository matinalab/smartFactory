<template>
  <div class="smart-factory">
    <div class="header">
      <h1>æ™ºæ…§å·¥å‚ç›‘æ§ä¸­å¿ƒ</h1>
      <div class="controls">
        <button @click="refreshData" class="refresh-btn">åˆ·æ–°æ•°æ®</button>
        <button @click="toggleFullscreen" class="fullscreen-btn">
          {{ isFullscreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±æ˜¾ç¤º' }}
        </button>
      </div>
    </div>

    <div class="content">
      <div class="left-panel">
        <div class="stats-cards">
          <div class="stat-card">
            <h3>è®¾å¤‡çŠ¶æ€</h3>
            <div class="stat-number">{{ stats.totalDevices }}</div>
            <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
          </div>
          <div class="stat-card">
            <h3>è¿è¡Œä¸­</h3>
            <div class="stat-number running">{{ stats.runningDevices }}</div>
            <div class="stat-label">è¿è¡Œè®¾å¤‡</div>
          </div>
          <div class="stat-card">
            <h3>æ•…éšœ</h3>
            <div class="stat-number error">{{ stats.errorDevices }}</div>
            <div class="stat-label">æ•…éšœè®¾å¤‡</div>
          </div>
          <div class="stat-card">
            <h3>æ•ˆç‡</h3>
            <div class="stat-number">{{ stats.efficiency }}%</div>
            <div class="stat-label">æ•´ä½“æ•ˆç‡</div>
          </div>
        </div>

        <div class="alerts-panel">
          <div class="alerts-header">
            <h3>å®æ—¶æƒ…å†µ</h3>
            <div class="ws-status" :class="{ connected: wsConnected }">
              <span class="status-dot"></span>
              <span class="status-text">{{ wsConnected ? 'WebSocket å·²è¿æ¥' : 'WebSocket æœªè¿æ¥' }}</span>
            </div>
          </div>
          <div class="alert-list">
            <div 
              v-for="alert in alerts" 
              :key="alert.id" 
              class="alert-item"
              :class="alert.level"
            >
              <span class="alert-time">{{ alert.time }}</span>
              <span class="alert-message">{{ alert.message }}</span>
              <span class="alert-level">{{ alert.level }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="main-panel">
        <FactoryFloorPlan 
          ref="floorPlanRef"
          :factoryData="factoryData"
          @area-click="handleAreaClick"
          @device-click="handleDeviceClick"
        />
      </div>

      <div class="right-panel">
        <div class="device-details" v-if="selectedDevice">
          <h3>è®¾å¤‡è¯¦æƒ…</h3>
          <div class="device-info">
            <div class="info-item">
              <span class="label">è®¾å¤‡åç§°:</span>
              <span class="value">{{ selectedDevice.name }}</span>
            </div>
            <div class="info-item">
              <span class="label">è®¾å¤‡ç±»å‹:</span>
              <span class="value">{{ selectedDevice.type }}</span>
            </div>
            <div class="info-item">
              <span class="label">è¿è¡ŒçŠ¶æ€:</span>
              <span class="value" :class="selectedDevice.status">{{ selectedDevice.status }}</span>
            </div>
            <div class="info-item">
              <span class="label">æ•ˆç‡:</span>
              <span class="value">{{ selectedDevice.efficiency }}%</span>
            </div>
            <div class="info-item">
              <span class="label">æ¸©åº¦:</span>
              <span class="value">{{ selectedDevice.temperature }}Â°C</span>
            </div>
          </div>
          <div class="device-controls">
            <button @click="controlDevice('start')" class="control-btn start">å¯åŠ¨</button>
            <button @click="controlDevice('stop')" class="control-btn stop">åœæ­¢</button>
            <button @click="controlDevice('restart')" class="control-btn restart">é‡å¯</button>
            <button 
              v-if="selectedDevice?.type === 'forklift'" 
              @click="moveForklift" 
              :disabled="forkliftMoving"
              class="control-btn transport"
            >
              {{ forkliftMoving ? 'è¿è¾“ä¸­...' : 'è¿è¾“ç‰©æ–™' }}
            </button>
            <button @click="show3DModel" class="control-btn model-3d">
              æŸ¥çœ‹3Dæ¨¡å‹
            </button>
          </div>
        </div>

        <div class="area-details" v-if="selectedArea">
          <h3>åŒºåŸŸè¯¦æƒ…</h3>
          <div class="area-info">
            <div class="info-item">
              <span class="label">åŒºåŸŸåç§°:</span>
              <span class="value">{{ selectedArea.name }}</span>
            </div>
            <div class="info-item">
              <span class="label">è®¾å¤‡æ•°é‡:</span>
              <span class="value">{{ selectedArea.deviceCount }}</span>
            </div>
            <div class="info-item">
              <span class="label">è¿è¡ŒçŠ¶æ€:</span>
              <span class="value" :class="selectedArea.status">{{ selectedArea.status }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- æ·»åŠ 3Dæ¨¡å‹å¼¹çª—ç»„ä»¶ -->
    <Device3DModal 
      :visible="show3DModalVisible"
      :device-data="selectedDevice"
      :device-name="selectedDevice?.name"
      @close="close3DModal"
    />
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, onUnmounted } from 'vue'
import FactoryFloorPlan from './components/factoryFloorPlan.vue'
import Device3DModal from './components/Device3DModal.vue'
import { factoryApi, statsApi, devicesApi, alertsApi } from '@/api'
import { useWebSocket } from '@/composables/useWebSocket'

// å“åº”å¼æ•°æ®
const floorPlanRef = ref(null)
const isFullscreen = ref(false)
const selectedDevice = ref(null)
const selectedArea = ref(null)
const forkliftMoving = ref(false)
const show3DModalVisible = ref(false)

// WebSocket è¿æ¥
const { connect: connectWebSocket, on: onWebSocket, disconnect: disconnectWebSocket, isConnected: wsConnected } = useWebSocket()

// åæ ‡è½¬æ¢å‡½æ•°
const GRID_SIZE = 20

// ç½‘æ ¼åæ ‡è½¬åƒç´ åæ ‡
const gridToPixel = (gridX, gridY) => {
  // è·å–å­ç»„ä»¶çš„å®é™…SVGé«˜åº¦
  const actualHeight = floorPlanRef.value?.svgSize?.height || 600
  return {
    x: gridX * GRID_SIZE,
    y: actualHeight - (gridY * GRID_SIZE)
  }
}

// åƒç´ åæ ‡è½¬ç½‘æ ¼åæ ‡  
const pixelToGrid = (pixelX, pixelY) => {
  const actualHeight = floorPlanRef.value?.svgSize?.height || 600
  return {
    gridX: Math.round(pixelX / GRID_SIZE),
    gridY: Math.round((actualHeight - pixelY) / GRID_SIZE)
  }
}

// è·å–æ™ºèƒ½è¿æ¥è·¯å¾„
const getConnectionCurvePath = (fromAreaId, toAreaId) => {
  // ç›´æ¥ä½¿ç”¨å­ç»„ä»¶çš„æ™ºèƒ½è¿æ¥ç³»ç»Ÿ
  const connection = { from: fromAreaId, to: toAreaId }
  return floorPlanRef.value?.getConnectionCurvePoints(connection) || []
}

const stats = reactive({
  totalDevices: 0,
  runningDevices: 0,
  errorDevices: 0,
  efficiency: 0
})

const alerts = ref([
  // { id: 1, time: '14:30:25', message: 'CNCæœºåºŠæ¸©åº¦å¼‚å¸¸', level: 'warning' },
  // { id: 2, time: '14:28:10', message: 'æµæ°´çº¿Båœæœºå‘Šè­¦', level: 'error' },
  // { id: 3, time: '14:25:45', message: 'åŸæ–™ä»“åº“å­˜ä¸è¶³', level: 'info' }
])

// æ–°å¸ƒå±€é…ç½®: æ–™åº“ -> æŠ•æ–™ -> ç”Ÿäº§ + æ¸…æ´— -> çŒè£… -> æˆå“åº“
const COLS = 5
const ROWS = 2
const ROOM_CONFIGS = [
  // ä¸»æµç¨‹ï¼ˆç¬¬0è¡Œï¼‰
  { id: 'warehouse', row: 0, col: 0.5, width: 8, height: 6 },        // æ–™åº“
  { id: 'feeding', row: 0, col: 2, width: 10, height: 6 },          // æŠ•æ–™åŒº
  { id: 'production', row: 0, col: 3.5, width: 10, height: 6 },      // ç”Ÿäº§è½¦é—´
  
  // ï¼ˆç¬¬1è¡Œï¼‰
  { id: 'cleaning', row: 1, col: 3.5, width: 10, height: 6 },          // æ¸…æ´—åŒº
  { id: 'filling', row: 1, col: 2, width: 9, height: 8 },          // çŒè£…åŒº
  { id: 'finished_goods', row: 1, col: 0.5, width: 8, height: 8 },   // æˆå“åº“

]

// è®¡ç®—æˆ¿é—´åœ¨æŒ‡å®šè¡Œåˆ—ä¸­çš„å±…ä¸­ä½ç½®
const calculateRoomPosition = (row, col, roomWidth, roomHeight) => {
  // è·å–SVGå®é™…å®½åº¦å’Œé«˜åº¦
  const svgElement = document.querySelector('.factory-svg')
  const svgWidth = svgElement ? svgElement.getBoundingClientRect().width : 800
  const svgHeight = svgElement ? svgElement.getBoundingClientRect().height : 600
  
  // è®¡ç®—æ¯åˆ—çš„å®½åº¦å’Œæ¯è¡Œçš„é«˜åº¦
  const colWidth = svgWidth / COLS
  const rowHeight = svgHeight / ROWS
  
  // è®¡ç®—è¯¥åˆ—çš„èµ·å§‹Xåæ ‡ï¼ˆåƒç´ ï¼‰
  const colStartX = col * colWidth
  
  // è®¡ç®—è¯¥è¡Œçš„èµ·å§‹Yåæ ‡ï¼ˆåƒç´ ï¼Œä»ä¸Šå¾€ä¸‹ï¼‰
  const rowStartY = row * rowHeight
  
  // æˆ¿é—´åœ¨è¯¥åˆ—ä¸­æ°´å¹³å±…ä¸­
  const roomPixelWidth = roomWidth * GRID_SIZE
  const roomStartX = colStartX + (colWidth - roomPixelWidth) / 2
  
  // æˆ¿é—´åœ¨è¯¥è¡Œä¸­å‚ç›´å±…ä¸­
  const roomPixelHeight = roomHeight * GRID_SIZE
  const roomStartY = rowStartY + (rowHeight - roomPixelHeight) / 2
  
  // è½¬æ¢ä¸ºç½‘æ ¼åæ ‡ï¼ˆæ³¨æ„Yè½´éœ€è¦åè½¬ï¼Œå› ä¸ºèµ·ç‚¹åœ¨å·¦ä¸‹è§’ï¼‰
  const gridX = Math.round(roomStartX / GRID_SIZE)
  const gridY = Math.round((svgHeight - roomStartY - roomPixelHeight) / GRID_SIZE)
  
  return { gridX, gridY }
}

// æ›´æ–°æ‰€æœ‰æˆ¿é—´ä½ç½®
const updateRoomPositions = () => {
  ROOM_CONFIGS.forEach(config => {
    const area = factoryData.value.areas.find(a => a.id === config.id)
    if (area) {
      const oldPosition = { gridX: area.gridX, gridY: area.gridY }
      const newPosition = calculateRoomPosition(config.row, config.col, config.width, config.height)
      const deltaX = newPosition.gridX - oldPosition.gridX
      const deltaY = newPosition.gridY - oldPosition.gridY
      
      // æ›´æ–°æˆ¿é—´ä½ç½®
      area.gridX = newPosition.gridX
      area.gridY = newPosition.gridY
      
      // åŒæ­¥ç§»åŠ¨æˆ¿é—´å†…çš„è®¾å¤‡
      area.devices.forEach(device => {
        device.gridX += deltaX
        device.gridY += deltaY
      })
    }
  })
}

const factoryData = ref({
  areas: [],
  connections: []
})

// åŠ è½½å·¥å‚æ•°æ®
const loadFactoryData = async () => {
  try {
    const res = await factoryApi.getFactoryData()
    console.log('res', res);
    factoryData.value = res.data
  } catch (err) {
    console.error('åŠ è½½å¤±è´¥:', err)
  }
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
const loadStats = async () => {
  try {
    const response = await statsApi.getStats()
    const data = response.data || {}
    Object.assign(stats, data) // æ›´æ–°reactiveçš„stats
  } catch (err) {
    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', err)
  }
}

// åŠ è½½å‘Šè­¦æ•°æ®
const loadAlerts = async () => {
  try {
    const response = await alertsApi.getAll()
    
    const data = response.data || []
    alerts.value = data.map(alert => ({
      id: alert.id,
      time: new Date(alert.time).toLocaleTimeString('zh-CN', { hour12: false }),
      message: alert.message,
      level: alert.level
    }))
  } catch (err) {
    console.error('åŠ è½½å‘Šè­¦æ•°æ®å¤±è´¥:', err)
  }
}

// å¯åŠ¨å‘Šè­¦ç”Ÿæˆå™¨
const startAlertGenerator = async () => {
  try {
    const response = await alertsApi.startGenerator()
    console.log('å‘Šè­¦ç”Ÿæˆå™¨å¯åŠ¨æˆåŠŸ:', response)
  } catch (err) {
    console.error('å¯åŠ¨å‘Šè­¦ç”Ÿæˆå™¨å¤±è´¥:', err)
  }
}

// åˆå§‹åŒ– WebSocket è¿æ¥
const initWebSocket = () => {
  // è¿æ¥åˆ°å‘Šè­¦ WebSocket æœåŠ¡
  const wsUrl = import.meta.env.VITE_WS_URL || 'http://localhost:3000'
  connectWebSocket(wsUrl, '/alerts')
  
  // ç›‘å¬æ–°å‘Šè­¦æ¨é€
  onWebSocket('new-alert', (alert) => {
    console.log('ğŸ“¢ æ”¶åˆ°æ–°å‘Šè­¦æ¨é€:', alert)
    
    // æ ¼å¼åŒ–æ—¶é—´å¹¶æ·»åŠ åˆ°å‘Šè­¦åˆ—è¡¨é¡¶éƒ¨
    const formattedAlert = {
      id: alert.id,
      time: new Date(alert.time).toLocaleTimeString('zh-CN', { hour12: false }),
      message: alert.message,
      level: alert.level
    }
    
    // æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
    alerts.value.unshift(formattedAlert)
    
    // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼ˆå¯é€‰ï¼‰
    if (alerts.value.length > 10) {
      alerts.value = alerts.value.slice(0, 10)
    }
    
    // åˆ·æ–°ç»Ÿè®¡æ•°æ®
    loadStats()
  })
  
  // ç›‘å¬å‘Šè­¦åˆ é™¤é€šçŸ¥
  onWebSocket('alert-deleted', (alertId) => {
    console.log('ğŸ—‘ï¸ å‘Šè­¦å·²åˆ é™¤:', alertId)
    const index = alerts.value.findIndex(a => a.id === alertId)
    if (index !== -1) {
      alerts.value.splice(index, 1)
    }
  })
  
  // ç›‘å¬å‘Šè­¦æ¸…ç©ºé€šçŸ¥
  onWebSocket('alerts-cleared', () => {
    console.log('ğŸ§¹ å‘Šè­¦å·²æ¸…ç©º')
    alerts.value = []
  })
}

// å…¨å±€åˆ·æ–°å‡½æ•°
const refreshData = async () => {
  await Promise.all([
    loadFactoryData(),
    loadStats(),
    loadAlerts()
  ])
  updateStats()
}

// const factoryData = reactive({
//   areas: [
//     {
//       id: 'warehouse',
//       name: 'åŸæ–™ä»“åº“',
//       type: 'storage',
//       gridX: 3,
//       gridY: 15,
//       gridWidth: 8,
//       gridHeight: 5,
//       devices: [
//         { id: 'forklift1', name: 'å‰è½¦1', type: 'forklift', status: 'idle', gridX: 4, gridY: 17, efficiency: 75, temperature: 28 },
//         { id: 'shelf1', name: 'è´§æ¶AåŒº', type: 'shelf', status: 'normal', gridX: 7, gridY: 18, efficiency: 100, temperature: 22 }
//       ]
//     },
//     {
//       id: 'production2',
//       name: 'ç”Ÿäº§çº¿B',
//       type: 'production',
//       gridX: 15,
//       gridY: 15,
//       gridWidth: 9,
//       gridHeight: 7,
//       devices: [
//         { id: 'robot2', name: 'æœºæ¢°è‡‚B1', type: 'robot', status: 'running', gridX: 20, gridY: 19.5, efficiency: 92, temperature: 41 },
//         { id: 'cnc2', name: 'CNCæœºåºŠ2', type: 'cnc', status: 'error', gridX: 20, gridY: 17, efficiency: 0, temperature: 78 }
//       ]
//     },
//     {
//       id: 'assembly',
//       name: 'ç»„è£…è½¦é—´', 
//       type: 'production',
//       gridX: 27,
//       gridY: 15,
//       gridWidth: 10,
//       gridHeight: 7,
//       devices: [
//         { id: 'robot1', name: 'æœºæ¢°è‡‚A1', type: 'robot', status: 'running', gridX: 29, gridY: 19.5, efficiency: 95, temperature: 42 },
//         { id: 'cnc1', name: 'CNCæœºåºŠ1', type: 'cnc', status: 'warning', gridX: 29, gridY: 17, efficiency: 88, temperature: 58 },
//         { id: 'conveyor1', name: 'ä¼ è¾“å¸¦1', type: 'conveyor', status: 'running', gridX: 32, gridY: 17, efficiency: 92, temperature: 35 }
//       ]
//     },
//     {
//       id: 'testing',
//       name: 'è´¨é‡æ£€æµ‹åŒº',
//       type: 'quality',
//       gridX: 40,
//       gridY: 15,
//       gridWidth: 9,
//       gridHeight: 6,
//       devices: [
//         { id: 'tester1', name: 'è´¨é‡æ£€æµ‹ä»ª1', type: 'tester', status: 'running', gridX: 42, gridY: 17.5, efficiency: 90, temperature: 45 },
//         { id: 'camera1', name: 'è§†è§‰æ£€æµ‹ç›¸æœº', type: 'camera', status: 'running', gridX: 45, gridY: 18.5, efficiency: 96, temperature: 38 }
//       ]
//     },
//   ],
//   connections: [
//     {
//       from: 'warehouse',
//       to: 'production2',
//       type: 'material',
//       component: {          
//         type: 'valve',      
//         status: 'running', 
//         name: 'æ§åˆ¶é˜€é—¨V001',
//         id: 'comp1'
//       }
//     },
//     {
//       from: 'production2',
//       to: 'assembly',
//       type: 'product',
//       component: {
//         type: 'sensor',
//         status: 'normal', 
//         name: 'æ¸©åº¦ä¼ æ„Ÿå™¨T002',
//         id: 'comp2'
//       }
//     },
//     {
//       from: 'assembly',
//       to: 'testing',
//       type: 'product',
//       component: {
//         type: 'pump',
//         status: 'error', 
//         name: 'å‹åŠ›æ³µF003',
//         id: 'comp3'
//       }
//     },
//   ]
// })

const toggleFullscreen = () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen()
    isFullscreen.value = true
  } else {
    document.exitFullscreen()
    isFullscreen.value = false
  }
}

const handleAreaClick = (area) => {
  selectedDevice.value = null
  selectedArea.value = area
  console.log('ç‚¹å‡»åŒºåŸŸ:', area)
}

const handleDeviceClick = (device) => {
  selectedArea.value = null
  selectedDevice.value = device
  console.log('ç‚¹å‡»è®¾å¤‡:', device)
}

const controlDevice = async (action) => {
  if (selectedDevice.value) {
    // æ‰¾åˆ°è®¾å¤‡åœ¨åŸå§‹æ•°æ®ä¸­çš„ä½ç½®
    const targetArea = factoryData.value.areas.find(area => 
      area.devices.some(device => device.id === selectedDevice.value.id)
    )
    const targetDevice = targetArea?.devices.find(device => 
      device.id === selectedDevice.value.id
    )
    
    if (targetDevice) {
      // æ ¹æ®æ“ä½œæ›´æ–°çŠ¶æ€
      switch(action) {
        case 'start':
          targetDevice.status = 'running'
          selectedDevice.value.status = 'running'
          console.log(`å¯åŠ¨è®¾å¤‡: ${selectedDevice.value.name}`)
          break
        case 'stop':
          targetDevice.status = 'idle'
          selectedDevice.value.status = 'idle'
          console.log(`åœæ­¢è®¾å¤‡: ${selectedDevice.value.name}`)
          break
        case 'restart':
          targetDevice.status = 'idle'
          selectedDevice.value.status = 'idle'
          console.log(`é‡å¯è®¾å¤‡: ${selectedDevice.value.name}`)
          setTimeout(() => {
            if (targetDevice && selectedDevice.value?.id === targetDevice.id) {
              targetDevice.status = 'running'
              selectedDevice.value.status = 'running'
            }
          }, 1000)
          break
      }
      
      // åˆ·æ–°ç»Ÿè®¡æ•°æ®
      await loadStats()
    }
  }
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®çš„æ–¹æ³•
const updateStats = () => {
  const devices = factoryData.value.areas.flatMap(area => area.devices)
  stats.totalDevices = devices.length
  stats.runningDevices = devices.filter(d => d.status === 'running').length
  stats.errorDevices = devices.filter(d => d.status === 'error').length
  stats.efficiency = Math.round((stats.runningDevices / stats.totalDevices) * 100)
}

// å‰è½¦ç§»åŠ¨åŠ¨ç”»å‡½æ•°
const moveForklift = async () => {
  if (forkliftMoving.value) return
  
  // æ‰¾åˆ°å‰è½¦è®¾å¤‡
  const warehouseArea = factoryData.value.areas.find(area => area.id === 'warehouse')
  const forklift = warehouseArea?.devices.find(device => device.id === 'forklift1')
  
  if (!forklift) return
  
  // æ¸…ç†å¯èƒ½çš„æ®‹ç•™åŠ¨ç”»åæ ‡
  delete forklift._animationX
  delete forklift._animationY
  
  // ä¿å­˜åŸå§‹ä½ç½®
  forkliftMoving.value = true
  forklift.status = 'running'
  updateStats()
  
  // è·å–å®é™…çš„è¿æ¥çº¿è·¯å¾„
  const curvePoints = getConnectionCurvePath('warehouse', 'feeding')
  if (!curvePoints.length) {
    forkliftMoving.value = false
    return
  }
  
  // è®¾ç½®ç§»åŠ¨è·¯å¾„(ç®€åŒ–ç‰ˆï¼Œè·Ÿè¿”å›è·¯å¾„ä¿æŒä¸€è‡´)
  const forkliftCurrentPos = gridToPixel(forklift.gridX, forklift.gridY)
  const path = [
    forkliftCurrentPos, // å‰è½¦å½“å‰ä½ç½®
    curvePoints[0], // warehouseè¿æ¥çº¿èµ·ç‚¹
    curvePoints[curvePoints.length - 1], // feedingè¿æ¥çº¿ç»ˆç‚¹
    { // ç›®æ ‡åŒºåŸŸå†…éƒ¨ä½ç½®
      x: curvePoints[curvePoints.length - 1].x + 20, 
      y: curvePoints[curvePoints.length - 1].y
    }
  ]
  
  // ç®€åŒ–æ—¶é—´é…ç½®
  const segmentDurations = [
    800,  // åˆ°è¿æ¥èµ·ç‚¹
    2000, // æ²¿è¿æ¥çº¿ç§»åŠ¨
    800   // è¿›å…¥ç›®æ ‡åŒºåŸŸ
  ]
  
  // æ‰§è¡Œç§»åŠ¨åŠ¨ç”»
  for (let i = 0; i < path.length - 1; i++) {
    await animateMovement(forklift, path[i], path[i + 1], segmentDurations[i] || 1500)
  }
  
  // åœ¨ç›®æ ‡ä½ç½®åœç•™ - è§¦å‘æ—‹è½¬åŠ¨ç”»
  floorPlanRef.value?.setWorkingAnimation(forklift)
  await new Promise(resolve => setTimeout(resolve, 2000))
  floorPlanRef.value?.clearWorkingAnimation()
  
  // è¿”å›è·¯å¾„ - ç›´æ¥å°†å»ç¨‹è·¯å¾„åè½¬
  const returnPath = [...path].reverse()
  
  // è¿”å›è·¯å¾„æ—¶é—´é…ç½® - å°†å»ç¨‹æ—¶é—´é…ç½®åè½¬
  const returnDurations = [...segmentDurations].reverse()
  
  for (let i = 0; i < returnPath.length - 1; i++) {
    await animateMovement(forklift, returnPath[i], returnPath[i + 1], returnDurations[i] || 1000)
  }
  
  // æ¢å¤çŠ¶æ€
  forklift.status = 'idle'
  forkliftMoving.value = false
  // ç¡®ä¿æ¸…ç†æ‰€æœ‰åŠ¨ç”»åæ ‡
  delete forklift._animationX
  delete forklift._animationY
  updateStats()
}

// å¹³æ»‘ç§»åŠ¨åŠ¨ç”»
const animateMovement = (device, startPos, endPos, duration) => {
  return new Promise(resolve => {
    const startTime = Date.now()
    
    const animate = () => {
      const elapsed = Date.now() - startTime
      const progress = Math.min(elapsed / duration, 1)
      
      // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°
      const easeProgress = 1 - Math.pow(1 - progress, 3)
      
      // è®¡ç®—å½“å‰åƒç´ ä½ç½®
      const currentX = startPos.x + (endPos.x - startPos.x) * easeProgress
      const currentY = startPos.y + (endPos.y - startPos.y) * easeProgress
      
      // åŠ¨ç”»è¿‡ç¨‹ä¸­ä½¿ç”¨ç²¾ç¡®çš„åƒç´ åæ ‡
      // ä¸ºåŠ¨ç”»æ·»åŠ ä¸´æ—¶çš„ç²¾ç¡®åæ ‡å±æ€§
      device._animationX = currentX
      device._animationY = currentY
      
      if (progress < 1) {
        requestAnimationFrame(animate)
      } else {
        // åŠ¨ç”»ç»“æŸï¼Œæ›´æ–°æœ€ç»ˆç½‘æ ¼åæ ‡å¹¶æ¸…ç†ä¸´æ—¶åæ ‡
        const endGridCoords = pixelToGrid(endPos.x, endPos.y)
        device.gridX = endGridCoords.gridX
        device.gridY = endGridCoords.gridY
        // æ¸…ç†ä¸´æ—¶åŠ¨ç”»åæ ‡
        delete device._animationX
        delete device._animationY
        resolve()
      }
    }
    
    animate()
  })
}

// æ˜¾ç¤º3Dæ¨¡å‹
const show3DModel = () => {
  if (selectedDevice.value) {
    // ä¿å­˜å½“å‰è§†å›¾çŠ¶æ€
    floorPlanRef.value?.saveCurrentView()
    
    // ä»¥é€‰ä¸­çš„è®¾å¤‡ä¸ºä¸­å¿ƒè¿›è¡Œç¼©æ”¾
    floorPlanRef.value?.zoomToDevice(selectedDevice.value, 2.5)
    
    // æ˜¾ç¤º3Dæ¨¡å‹å¼¹çª—
    show3DModalVisible.value = true
  }
}

// å…³é—­3Dæ¨¡å‹å¼¹çª—
const close3DModal = () => {
  show3DModalVisible.value = false
  
  // é‡ç½®è§†å›¾ï¼Œè®©å¼¹çª—å…³é—­åŠ¨ç”»å®Œæˆ
  setTimeout(() => {
    floorPlanRef.value?.restoreView()
  }, 100)
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(async () => {
  // åŠ è½½æ•°æ®
  await refreshData()

  // åˆå§‹åŒ– WebSocket è¿æ¥ï¼ˆä¼˜å…ˆå»ºç«‹è¿æ¥ï¼‰
  initWebSocket()

  // å¯åŠ¨å‘Šè­¦ç”Ÿæˆå™¨ï¼ˆå»¶è¿Ÿ2ç§’å¯åŠ¨ï¼‰
  setTimeout(() => {
    startAlertGenerator()
  }, 2000)

  // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
  document.addEventListener('fullscreenchange', () => {
    isFullscreen.value = !!document.fullscreenElement
  })
  
  // åˆå§‹åŒ–å¸ƒå±€
  setTimeout(() => {
    updateRoomPositions()
  }, 0)
  
  // ç›‘å¬çª—å£å¤§å°å˜åŒ–
  let parentResizeTimeout = null
  window.addEventListener('resize', () => {
    clearTimeout(parentResizeTimeout)
    parentResizeTimeout = setTimeout(() => {
      updateRoomPositions()
    }, 150)
  })
})

onUnmounted(() => {
  // æ–­å¼€ WebSocket è¿æ¥
  disconnectWebSocket()
  
  // æ¸…ç†å…¶ä»–ç›‘å¬å™¨
  document.removeEventListener('fullscreenchange', () => {})
  window.removeEventListener('resize', updateRoomPositions)
})
</script>

<style scoped>
.smart-factory {
  height: 100vh;
  width: 100vw;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
  position: relative;
}

/* æ‰«æçº¿æ•ˆæœ */
.smart-factory::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: repeating-linear-gradient(
    0deg,
    rgba(0, 255, 255, 0.03) 0px,
    transparent 1px,
    transparent 2px,
    rgba(0, 255, 255, 0.03) 3px
  );
  pointer-events: none;
  z-index: 1;
  animation: scanline 8s linear infinite;
}

@keyframes scanline {
  0% { transform: translateY(0); }
  100% { transform: translateY(100vh); }
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: linear-gradient(180deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 31, 58, 0.9) 100%);
  box-shadow: 0 4px 20px rgba(0, 255, 255, 0.1), 
              0 0 40px rgba(139, 92, 246, 0.05);
  border-bottom: 2px solid rgba(0, 255, 255, 0.3);
  position: relative;
  z-index: 2;
}

.header h1 {
  margin: 0;
  color: #00ffff;
  font-weight: 700;
  text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
  letter-spacing: 2px;
  animation: glitch 3s infinite;
}

@keyframes glitch {
  0%, 90%, 100% { transform: translate(0); }
  92% { transform: translate(-2px, 1px); text-shadow: 0 0 10px #ff006e; }
  96% { transform: translate(-1px, 2px); text-shadow: 0 0 10px #8b5cf6; }
}

.controls {
  display: flex;
  gap: 10px;
  position: relative;
  z-index: 2;
}

.refresh-btn, .fullscreen-btn {
  padding: 10px 20px;
  border: 2px solid;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  background: rgba(0, 255, 255, 0.1);
  color: #00ffff;
  border-color: #00ffff;
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.3),
              inset 0 0 10px rgba(0, 255, 255, 0.1);
  outline: none; /* ç§»é™¤é»˜è®¤outline */
}

.refresh-btn:hover, .fullscreen-btn:hover {
  background: rgba(0, 255, 255, 0.2);
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.6),
              inset 0 0 15px rgba(0, 255, 255, 0.2);
  transform: translateY(-2px);
}

/* ç‚¹å‡»å’Œç„¦ç‚¹çŠ¶æ€ä¿æŒé’è‰²è¾¹æ¡† */
.refresh-btn:focus, .fullscreen-btn:focus,
.refresh-btn:active, .fullscreen-btn:active {
  outline: none;
  border-color: #00ffff;
  background: rgba(0, 255, 255, 0.2);
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.6),
              inset 0 0 15px rgba(0, 255, 255, 0.2);
}

.content {
  flex: 1;
  display: flex;
  overflow: hidden;
  padding: 20px;
  gap: 20px;
  position: relative;
  z-index: 2;
}

.left-panel, .right-panel {
  width: 300px;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  gap: 20px;
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
.left-panel::-webkit-scrollbar,
.right-panel::-webkit-scrollbar {
  width: 8px;
}

.left-panel::-webkit-scrollbar-track,
.right-panel::-webkit-scrollbar-track {
  background: rgba(0, 255, 255, 0.05);
  border-radius: 4px;
}

.left-panel::-webkit-scrollbar-thumb,
.right-panel::-webkit-scrollbar-thumb {
  background: rgba(0, 255, 255, 0.3);
  border-radius: 4px;
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}

.main-panel {
  flex: 1;
}

.stats-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.stat-card {
  background: linear-gradient(135deg, rgba(26, 31, 58, 0.8) 0%, rgba(10, 14, 39, 0.9) 100%);
  padding: 20px;
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 255, 0.3);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5),
              0 0 20px rgba(0, 255, 255, 0.1),
              inset 0 0 20px rgba(0, 255, 255, 0.05);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    45deg,
    transparent 30%,
    rgba(0, 255, 255, 0.1) 50%,
    transparent 70%
  );
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.stat-card h3 {
  color: #00ffff;
  margin: 0 0 10px 0;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.stat-number {
  font-size: 32px;
  font-weight: bold;
  margin: 10px 0;
  color: #00ffff;
  text-shadow: 0 0 15px rgba(0, 255, 255, 0.8),
               0 0 30px rgba(0, 255, 255, 0.4);
  animation: numberPulse 2s ease-in-out infinite;
}

@keyframes numberPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.stat-number.running {
  color: #00ff88;
  text-shadow: 0 0 15px rgba(0, 255, 136, 0.8),
               0 0 30px rgba(0, 255, 136, 0.4);
}

.stat-number.error {
  color: #ff006e;
  text-shadow: 0 0 15px rgba(255, 0, 110, 0.8),
               0 0 30px rgba(255, 0, 110, 0.4);
}

.stat-label {
  color: rgba(0, 255, 255, 0.7);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.alerts-panel {
  background: linear-gradient(135deg, rgba(26, 31, 58, 0.8) 0%, rgba(10, 14, 39, 0.9) 100%);
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 136, 0.3); /* ç»¿è‰²è¾¹æ¡† */
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5),
              0 0 20px rgba(255, 0, 110, 0.1);
  overflow: hidden;
}

.alerts-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(90deg, rgba(0, 255, 136, 0.2) 0%, transparent 100%); /* ç»¿è‰²æ¸å˜å¤´éƒ¨ */
  border-bottom: 1px solid rgba(0, 255, 136, 0.3); /* ç»¿è‰²è¾¹æ¡† */
}

.alerts-panel h3 {
  margin: 0;
  color: #90ee90; /* æ ‡é¢˜æ”¹ä¸ºæµ…ç»¿è‰² */
  text-shadow: 0 0 10px rgba(0, 255, 136, 0.8); /* ç»¿è‰²é˜´å½± */
  text-transform: uppercase;
  letter-spacing: 2px;
  font-size: 14px;
}

/* WebSocket çŠ¶æ€æŒ‡ç¤ºå™¨ */
.ws-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: rgba(144, 238, 144, 0.7); /* æµ…ç»¿è‰²æ–‡å­— */
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #666;
  box-shadow: 0 0 8px rgba(102, 102, 102, 0.6);
  animation: pulse-disconnected 2s ease-in-out infinite;
}

.ws-status.connected .status-dot {
  background: #00ff88; /* ç»¿è‰² */
  box-shadow: 0 0 12px rgba(0, 255, 136, 0.8); /* ç»¿è‰²é˜´å½± */
  animation: pulse-connected 2s ease-in-out infinite;
}

.ws-status.connected .status-text {
  color: #00ff88; /* ç»¿è‰²æ–‡å­— */
}

@keyframes pulse-connected {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.7;
    transform: scale(1.1);
  }
}

@keyframes pulse-disconnected {
  0%, 100% {
    opacity: 0.5;
  }
  50% {
    opacity: 0.8;
  }
}

.alert-list {
  max-height: 300px;
  overflow-y: auto;
}

.alert-list::-webkit-scrollbar {
  width: 6px;
}

.alert-list::-webkit-scrollbar-track {
  background: rgba(0, 255, 136, 0.05); /* ç»¿è‰²æ»šåŠ¨æ¡èƒŒæ™¯ */
}

.alert-list::-webkit-scrollbar-thumb {
  background: rgba(0, 255, 136, 0.3); /* ç»¿è‰²æ»šåŠ¨æ¡æ»‘å— */
  border-radius: 3px;
}

.alert-item {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  border-bottom: 1px solid rgba(0, 255, 136, 0.1); /* ç»¿è‰²è¾¹æ¡† */
  font-size: 12px;
  transition: all 0.3s ease;
}

.alert-item:hover {
  background: rgba(0, 255, 136, 0.05); /* ç»¿è‰²hoverèƒŒæ™¯ */
}

.alert-item.error {
  background: rgba(255, 0, 110, 0.1); /* é”™è¯¯ä»ç”¨çº¢è‰²èƒŒæ™¯ */
  border-left: 3px solid #ff006e; /* é”™è¯¯ä»ç”¨çº¢è‰²è¾¹æ¡† */
  box-shadow: inset 0 0 20px rgba(255, 0, 110, 0.1);
}

.alert-item.warning {
  background: rgba(250, 173, 20, 0.1); /* è­¦å‘Šä»ç”¨æ©™è‰²èƒŒæ™¯ */
  border-left: 3px solid #faad14; /* è­¦å‘Šä»ç”¨æ©™è‰²è¾¹æ¡† */
  box-shadow: inset 0 0 20px rgba(250, 173, 20, 0.1);
}

.alert-item.info {
  background: rgba(0, 255, 136, 0.1); /* ä¿¡æ¯æ”¹ä¸ºç»¿è‰²èƒŒæ™¯ */
  border-left: 3px solid #00ff88; /* ä¿¡æ¯æ”¹ä¸ºç»¿è‰²è¾¹æ¡† */
  box-shadow: inset 0 0 20px rgba(0, 255, 136, 0.1);
}

.alert-time {
  width: 80px;
  color: rgba(144, 238, 144, 0.6); /* æµ…ç»¿è‰²æ–‡å­— */
  font-size: 11px;
}

.alert-message {
  flex: 1;
  color: #90ee90; /* å‘Šè­¦å†…å®¹æ”¹ä¸ºæµ…ç»¿è‰² */
}

.alert-level {
  width: 60px;
  text-align: center;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  text-transform: uppercase;
}

.device-details, .area-details {
  background: linear-gradient(135deg, rgba(26, 31, 58, 0.8) 0%, rgba(10, 14, 39, 0.9) 100%);
  border-radius: 8px;
  border: 1px solid rgba(139, 92, 246, 0.3);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5),
              0 0 20px rgba(139, 92, 246, 0.1);
  padding: 20px;
  position: relative;
}

.device-details::before,
.area-details::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, #8b5cf6, transparent);
  animation: borderGlow 2s linear infinite;
}

@keyframes borderGlow {
  0% { opacity: 0.5; }
  50% { opacity: 1; }
  100% { opacity: 0.5; }
}

.device-details h3, .area-details h3 {
  margin-top: 0;
  color: #8b5cf6;
  text-shadow: 0 0 10px rgba(139, 92, 246, 0.8);
  text-transform: uppercase;
  letter-spacing: 2px;
  font-size: 14px;
}

.info-item {
  display: flex;
  margin-bottom: 12px;
}

.info-item .label {
  width: 100px;
  color: rgba(0, 255, 255, 0.7);
  font-size: 12px;
  text-transform: uppercase;
}

.info-item .value {
  flex: 1;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
  font-size: 13px;
}

.value.running, .value.normal {
  color: #00ff88;
  text-shadow: 0 0 10px rgba(0, 255, 136, 0.6);
}

.value.error, .value.idle {
  color: #ff006e;
  text-shadow: 0 0 10px rgba(255, 0, 110, 0.6);
}

.device-controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
}

.control-btn {
  flex: none;
  padding: 8px 16px;
  border: 2px solid;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.control-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.4s, height 0.4s;
}

.control-btn:hover::before {
  width: 200%;
  height: 200%;
}

.control-btn.start {
  background: rgba(0, 255, 136, 0.1);
  color: #00ff88;
  border-color: #00ff88;
  box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
}

.control-btn.start:hover {
  background: rgba(0, 255, 136, 0.2);
  box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
  transform: translateY(-2px);
}

.control-btn.stop {
  background: rgba(255, 0, 110, 0.1);
  color: #ff006e;
  border-color: #ff006e;
  box-shadow: 0 0 10px rgba(255, 0, 110, 0.3);
}

.control-btn.stop:hover {
  background: rgba(255, 0, 110, 0.2);
  box-shadow: 0 0 20px rgba(255, 0, 110, 0.6);
  transform: translateY(-2px);
}

.control-btn.restart {
  background: rgba(0, 255, 255, 0.1);
  color: #00ffff;
  border-color: #00ffff;
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
}

.control-btn.restart:hover {
  background: rgba(0, 255, 255, 0.2);
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
  transform: translateY(-2px);
}

.control-btn.transport {
  background: rgba(250, 140, 22, 0.1);
  color: #fa8c16;
  border-color: #fa8c16;
  box-shadow: 0 0 10px rgba(250, 140, 22, 0.3);
}

.control-btn.transport:hover {
  background: rgba(250, 140, 22, 0.2);
  box-shadow: 0 0 20px rgba(250, 140, 22, 0.6);
  transform: translateY(-2px);
}

.control-btn.model-3d {
  background: rgba(139, 92, 246, 0.1);
  color: #8b5cf6;
  border-color: #8b5cf6;
  box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
}

.control-btn.model-3d:hover {
  background: rgba(139, 92, 246, 0.2);
  box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
  transform: translateY(-2px);
}

.control-btn:disabled {
  background: rgba(100, 100, 100, 0.1);
  color: #666;
  border-color: #666;
  box-shadow: none;
  cursor: not-allowed;
  transform: none;
}
</style>